#!/usr/bin/env python3

import re
from datetime import datetime

# Import static data
from core.static import ips, hostnames
from core.support import REWRITE

# Import parent class
from core.base import Base


class MalwareKit(Base):
    """
    Malware Kit class to write static list of hostnames and IPs that were
    obtained via Malware Kits located in core/static/agents.py

    :param workingfile: Open file object where rules are written
    :param ip_list:     List of seen IPs
    :param host_list:   List of seen Hosts
    """

    def __init__(self, workingfile, ip_list, host_list):
        self.workingfile = workingfile
        self.ip_list     = ip_list
        self.host_list   = host_list

        self.return_data = self._process_source()


    def _process_source(self):
        mk_ips = ips.malware_kit_ips
        mk_hostnames = hostnames.malware_kit_hostnames

        # Add hostnames and IPs obtained via Malware Kit
        print("[*]\tAdding Hostnames and IPs obtained via Malware Kit...")
        self.workingfile.write("\n\n\t# Hostnames/IPs obtained via Malware Kit: %s\n" % datetime.now().strftime("%Y%m%d-%H:%M:%S"))

        # Process hostnames
        self.workingfile.write("\n\t# Hostnames\n")
        count = 0
        for host in mk_hostnames:
            if host not in self.host_list and host != '':
                self.workingfile.write(REWRITE['COND_HOST'].format(HOSTNAME=host))
                self.host_list.append(host)  # Keep track of all things added
                count += 1

        self.workingfile.write("\t# Hostname Count: %d\n" % count)

        # Process IPs
        self.workingfile.write("\n\t# IPs\n")
        count = 0
        for ip in mk_ips:
            # Convert /31 and /32 CIDRs to single IP
            ip = re.sub('/3[12]', '', ip)

            # Convert lower-bound CIDRs into /24 by default
            # This is assmuming that if a portion of the net
            # was seen, we want to avoid the full netblock
            ip = re.sub('\.[0-9]{1,3}/(2[456789]|30)', '.0/24', ip)

            # Check if the current IP/CIDR has been seen
            if ip not in self.ip_list and ip != '':
                self.workingfile.write(REWRITE['COND_IP'].format(IP=ip))
                self.ip_list.append(ip)  # Keep track of all things added
                count += 1

        self.workingfile.write("\t# IP Count: %d\n" % count)

        # Ensure there are conditions to catch
        if count > 0:
            # Add rewrite rule... I think this should help performance
            self.workingfile.write("\n\t# Add RewriteRule for performance\n")
            self.workingfile.write(REWRITE['END_COND'])
            self.workingfile.write(REWRITE['RULE'])

        return (self.ip_list, self.host_list)